{% extends "base.html" %}

{% block title %}Dashboard - POS System{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Overview and quick actions{% endblock %}

{% block content %}
<div class="space-y-4 md:space-y-6">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
        <div class="bg-white rounded-xl shadow p-4 md:p-6">
            <div class="flex items-center">
                <div class="p-2 md:p-3 bg-indigo-100 rounded-lg">
                    <i class="fas fa-shopping-cart text-indigo-600 text-xl md:text-2xl"></i>
                </div>
                <div class="ml-3 md:ml-4">
                    <p class="text-xs md:text-sm text-gray-500">Today's Sales</p>
                    <h3 class="text-lg md:text-2xl font-bold">₦{{ "%.2f"|format(today_sales|default(0)) }}</h3>
                </div>
            </div>
            <p class="text-xs md:text-sm text-green-600 mt-2">
                <i class="fas fa-arrow-up mr-1"></i> 12% from yesterday
            </p>
        </div>

        <div class="bg-white rounded-xl shadow p-4 md:p-6">
            <div class="flex items-center">
                <div class="p-2 md:p-3 bg-green-100 rounded-lg">
                    <i class="fas fa-box text-green-600 text-xl md:text-2xl"></i>
                </div>
                <div class="ml-3 md:ml-4">
                    <p class="text-xs md:text-sm text-gray-500">Total Products</p>
                    <h3 class="text-lg md:text-2xl font-bold">{{ total_products }}</h3>
                </div>
            </div>
            <p class="text-xs md:text-sm text-gray-500 mt-2">{{ low_stock_count }} low in stock</p>
        </div>

        <div class="bg-white rounded-xl shadow p-4 md:p-6">
            <div class="flex items-center">
                <div class="p-2 md:p-3 bg-blue-100 rounded-lg">
                    <i class="fas fa-users text-blue-600 text-xl md:text-2xl"></i>
                </div>
                <div class="ml-3 md:ml-4">
                    <p class="text-xs md:text-sm text-gray-500">Total Customers</p>
                    <h3 class="text-lg md:text-2xl font-bold">{{ total_customers }}</h3>
                </div>
            </div>
            <p class="text-xs md:text-sm text-gray-500 mt-2">{{ new_customers_today }} new today</p>
        </div>

        <div class="bg-white rounded-xl shadow p-4 md:p-6">
            <div class="flex items-center">
                <div class="p-2 md:p-3 bg-yellow-100 rounded-lg">
                    <i class="fas fa-chart-line text-yellow-600 text-xl md:text-2xl"></i>
                </div>
                <div class="ml-3 md:ml-4">
                    <p class="text-xs md:text-sm text-gray-500">Inventory Value</p>
                    <h3 class="text-lg md:text-2xl font-bold">₦{{ "%.2f"|format(inventory_value|default(0)) }}</h3>
                </div>
            </div>
            <p class="text-xs md:text-sm text-gray-500 mt-2">Total stock value</p>
        </div>
    </div>

    <!-- Quick Actions & Low Stock -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
        <!-- Quick Actions -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow p-4 md:p-6">
                <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                    <a href="/pos" class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 md:p-4 text-center hover:bg-indigo-100 transition-colors duration-200">
                        <i class="fas fa-cash-register text-indigo-600 text-xl md:text-2xl mb-2"></i>
                        <p class="font-medium text-sm md:text-base">New Sale</p>
                        <p class="text-xs md:text-sm text-gray-500">Start a new transaction</p>
                    </a>

                    <a href="/inventory" class="bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4 text-center hover:bg-blue-100 transition-colors duration-200">
                        <i class="fas fa-boxes text-blue-600 text-xl md:text-2xl mb-2"></i>
                        <p class="font-medium text-sm md:text-base">Check Inventory</p>
                        <p class="text-xs md:text-sm text-gray-500">View stock levels</p>
                    </a>
                    <a href="/sales" class="bg-purple-50 border border-purple-200 rounded-lg p-3 md:p-4 text-center hover:bg-purple-100 transition-colors duration-200">
                        <i class="fas fa-receipt text-purple-600 text-xl md:text-2xl mb-2"></i>
                        <p class="font-medium text-sm md:text-base">View Sales</p>
                        <p class="text-xs md:text-sm text-gray-500">Sales history</p>
                    </a>
                </div>
            </div>
        </div>

        <!-- Low Stock Alert -->
        <div class="bg-white rounded-xl shadow p-4 md:p-6">
            <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-4">Low Stock Alert</h3>
            {% if low_stock_products %}
            <div class="space-y-3">
                {% for product in low_stock_products[:3] %}
                <div class="p-3 border border-yellow-200 bg-yellow-50 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm md:text-base text-gray-800 truncate">{{ product.name }}</p>
                            <div class="flex items-center mt-1">
                                <span class="text-xs md:text-sm text-gray-600">Stock: {{ product.stock_quantity }}</span>
                                {% if product.reorder_level %}
                                <span class="mx-2 text-gray-300">•</span>
                                <span class="text-xs text-gray-500">Reorder: {{ product.reorder_level }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <a href="/products/edit/{{ product.id }}" class="ml-2 text-indigo-600 hover:text-indigo-800 flex-shrink-0">
                            <i class="fas fa-edit text-sm md:text-base"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if low_stock_products|length > 3 %}
            <p class="text-xs md:text-sm text-gray-500 mt-3">+{{ low_stock_products|length - 3 }} more items</p>
            {% endif %}
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-check-circle text-green-500 text-2xl md:text-3xl mb-2"></i>
                <p class="text-sm md:text-base text-gray-500">All products have sufficient stock</p>
            </div>
            {% endif %}
            <a href="/inventory" class="block text-center mt-4 text-indigo-600 hover:text-indigo-800 font-medium text-sm md:text-base">
                View All Inventory <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
    </div>

    <!-- Recent Sales & Top Products -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
        <!-- Recent Sales -->
        <div class="bg-white rounded-xl shadow p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base md:text-lg font-semibold text-gray-800">
                    <i class="fas fa-history mr-2"></i>Recent Sales
                </h3>
                <a href="/sales" class="text-xs md:text-sm text-indigo-600 hover:text-indigo-800">
                    View All <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>

            {% if recent_sales %}
            <div class="space-y-3">
                {% for sale in recent_sales %}
                <div class="flex justify-between items-center p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors duration-150">
                    <div class="min-w-0">
                        <div class="font-medium text-sm md:text-base text-gray-800 truncate">#{{ sale.receipt_number }}</div>
                        <div class="text-xs text-gray-500 mt-1">{{ sale.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                    </div>
                    <div class="text-right ml-4 flex-shrink-0">
                        <div class="font-bold text-green-600 text-sm md:text-base">{{ format_naira(sale.total_amount) }}</div>
                        <div class="text-xs text-gray-500">{{ sale.payment_method|title }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-6 md:py-8">
                <i class="fas fa-receipt text-gray-300 text-3xl md:text-4xl mb-3"></i>
                <p class="text-sm md:text-base text-gray-500">No sales yet today</p>
                <a href="/pos" class="mt-2 inline-block text-indigo-600 hover:text-indigo-800 text-sm md:text-base">Make your first sale</a>
            </div>
            {% endif %}
        </div>

        <!-- Top Selling Products -->
        <div class="bg-white rounded-xl shadow p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base md:text-lg font-semibold text-gray-800">
                    <i class="fas fa-chart-line mr-2"></i>Top Selling Products
                </h3>
                <a href="/products" class="text-xs md:text-sm text-indigo-600 hover:text-indigo-800">
                    View All <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>

            {% if top_products %}
            <div class="space-y-3 md:space-y-4">
                {% for product in top_products %}
                <div class="flex items-center justify-between p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors duration-150">
                    <div class="flex items-center min-w-0">
                        <div class="w-8 h-8 md:w-10 md:h-10 bg-indigo-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            {% if loop.index == 1 %}
                            <i class="fas fa-trophy text-yellow-500 text-xs md:text-sm"></i>
                            {% elif loop.index == 2 %}
                            <i class="fas fa-medal text-gray-400 text-xs md:text-sm"></i>
                            {% elif loop.index == 3 %}
                            <i class="fas fa-award text-orange-500 text-xs md:text-sm"></i>
                            {% else %}
                            <span class="font-bold text-indigo-600 text-xs md:text-sm">{{ loop.index }}</span>
                            {% endif %}
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-medium text-sm md:text-base text-gray-800 truncate">{{ product.name }}</h4>
                            <p class="text-xs text-gray-500 truncate">{{ product.category }} • SKU: {{ product.sku }}</p>
                        </div>
                    </div>
                    <div class="text-right ml-4 flex-shrink-0">
                        <div class="font-bold text-sm md:text-lg">{{ product.total_sold }} sold</div>
                        <div class="text-xs md:text-sm text-gray-600">{{ format_naira(product.total_revenue) }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-6 md:py-8 text-gray-500">
                <i class="fas fa-chart-bar text-3xl md:text-4xl mb-2"></i>
                <p class="text-sm md:text-base">No sales data available yet</p>
                <p class="text-xs md:text-sm mt-2">Make some sales to see top products here</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Sales Table (Detailed View) -->
    <div class="bg-white rounded-xl shadow p-4 md:p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
            <h3 class="text-base md:text-lg font-semibold text-gray-800">Recent Sales (Detailed)</h3>
            <a href="/sales" class="text-xs md:text-sm text-indigo-600 hover:text-indigo-800">View All Sales</a>
        </div>

        {% if recent_sales %}
        <div class="overflow-x-auto -mx-4 md:mx-0">
            <div class="inline-block min-w-full align-middle">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-3 py-2 md:px-4 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Receipt #</th>
                            <th class="px-3 py-2 md:px-4 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Customer</th>
                            <th class="px-3 py-2 md:px-4 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                            <th class="px-3 py-2 md:px-4 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-3 py-2 md:px-4 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
                            <th class="px-3 py-2 md:px-4 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden xs:table-cell">Time</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for sale in recent_sales %}
                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                            <td class="px-3 py-2 md:px-4 md:py-3 whitespace-nowrap">
                                <span class="font-medium text-sm md:text-base">#{{ sale.receipt_number[-6:] }}</span>
                            </td>
                            <td class="px-3 py-2 md:px-4 md:py-3 whitespace-nowrap hidden sm:table-cell">
                                {% if sale.customer and sale.customer.name %}
                                <span class="text-sm md:text-base truncate max-w-[120px]">{{ sale.customer.name }}</span>
                                {% else %}
                                <span class="text-gray-400 text-sm">Walk-in</span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-2 md:px-4 md:py-3 whitespace-nowrap">
                                <span class="text-sm md:text-base">
                                    {% if sale.items %}
                                    {{ sale.items|length }} items
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </span>
                            </td>
                            <td class="px-3 py-2 md:px-4 md:py-3 whitespace-nowrap">
                                <span class="font-medium text-sm md:text-base">{{ format_naira(sale.total_amount) }}</span>
                            </td>
                            <td class="px-3 py-2 md:px-4 md:py-3 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full
                                    {% if sale.payment_method == 'cash' %}bg-green-100 text-green-800
                                    {% elif sale.payment_method == 'transfer' %}bg-blue-100 text-blue-800
                                    {% elif sale.payment_method == 'pos' %}bg-purple-100 text-purple-800
                                    {% elif sale.payment_method == 'mobile' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ sale.payment_method|title|slice(0, 4) }}{% if sale.payment_method|length > 4 %}...{% endif %}
                                </span>
                            </td>
                            <td class="px-3 py-2 md:px-4 md:py-3 whitespace-nowrap text-sm text-gray-500 hidden xs:table-cell">
                                {{ sale.created_at.strftime('%H:%M') }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="text-center py-6 md:py-8">
            <i class="fas fa-receipt text-gray-300 text-3xl md:text-4xl mb-3"></i>
            <p class="text-sm md:text-base text-gray-500">No sales yet today</p>
            <a href="/pos" class="mt-2 inline-block text-indigo-600 hover:text-indigo-800 text-sm md:text-base">Make your first sale</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Simple Naira formatting for numbers
document.addEventListener('DOMContentLoaded', function() {
    // Format all elements with class 'format-naira'
    document.querySelectorAll('.format-naira').forEach(el => {
        const amount = parseFloat(el.textContent.replace(/[^0-9.-]+/g, ''));
        if (!isNaN(amount)) {
            el.textContent = '₦' + amount.toLocaleString('en-NG', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    });

    // Add click animation to quick action cards
    document.querySelectorAll('.grid-cols-2 a').forEach(card => {
        card.addEventListener('click', function(e) {
            // Add a subtle click effect
            this.style.transform = 'scale(0.98)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });

    // Make sure table is scrollable on mobile
    const tables = document.querySelectorAll('table');
    tables.forEach(table => {
        if (table.scrollWidth > table.clientWidth) {
            table.closest('.overflow-x-auto').classList.add('pb-2');
        }
    });
});
</script>

<style>
/* Responsive breakpoints */
@media (max-width: 640px) {
    .xs\:table-cell {
        display: table-cell !important;
    }
}

@media (min-width: 640px) and (max-width: 767px) {
    .table-responsive {
        font-size: 0.875rem;
    }
}

/* Better truncation for mobile */
.truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Touch-friendly buttons and links */
@media (max-width: 768px) {
    a, button {
        min-height: 44px;
        min-width: 44px;
    }

    .hover\:bg-gray-50:hover {
        background-color: transparent;
    }

    .hover\:bg-indigo-100:hover,
    .hover\:bg-green-100:hover,
    .hover\:bg-blue-100:hover,
    .hover\:bg-purple-100:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
}

/* Improved loading states */
.loading {
    position: relative;
    overflow: hidden;
}

.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { left: -100%; }
    100% { left: 100%; }
}
</style>
{% endblock %}