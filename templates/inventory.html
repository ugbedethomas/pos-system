{% extends "base.html" %}

{% block title %}Inventory - POS System{% endblock %}
{% block page_title %}Inventory Management{% endblock %}
{% block page_subtitle %}Track stock levels and movements{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Inventory Summary -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Inventory Summary</h3>
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-gray-600">Total Products</span>
                <span class="font-bold">{{ inventory_report|length }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">Total Value</span>
                <span class="font-bold">₦{{ format_naira(inventory_report|sum(attribute='total_value')) }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">Low Stock Items</span>
                <span class="font-bold text-yellow-600">{{ low_stock_products|length }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">Out of Stock</span>
                <span class="font-bold text-red-600">{{ inventory_report|selectattr('status', 'equalto', 'OUT')|list|length }}</span>
            </div>
        </div>
    </div>

    <!-- Stock Alert -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Stock Alerts</h3>
                <button onclick="showStockAdjustmentModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">
                    <i class="fas fa-edit mr-1"></i> Adjust Stock
                </button>
            </div>

            {% if low_stock_products %}
            <div class="space-y-3">
                {% for product in low_stock_products[:5] %}
                <div class="flex items-center justify-between p-3 bg-yellow-50 border-l-4 border-yellow-500">
                    <div>
                        <p class="font-medium">{{ product.name }}</p>
                        <p class="text-sm text-gray-500">{{ product.sku }} • {{ product.category }}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-yellow-700">{{ product.stock_quantity }} / {{ product.reorder_level }}</p>
                        <p class="text-sm text-gray-500">Needs {{ product.reorder_level - product.stock_quantity }} more</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-3"></i>
                <p class="text-gray-600">All products have sufficient stock</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Inventory Report Table -->
<div class="bg-white rounded-xl shadow overflow-hidden mb-8">
    <div class="px-6 py-4 border-b">
        <h3 class="text-lg font-semibold text-gray-800">Inventory Report</h3>
        <p class="text-sm text-gray-500">Detailed stock information for all products</p>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Current Stock</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Min Level</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Value</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Updated</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in inventory_report %}
                <tr class="hover:bg-gray-50 {% if item.status == 'LOW' %}low-stock{% elif item.status == 'OUT' %}out-of-stock{% endif %}">
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">{{ item.product_name }}</div>
                        <div class="text-sm text-gray-500">ID: {{ item.product_id }}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-medium">{{ item.current_stock }}</span>
                    </td>
                    <td class="px-6 py-4">
                        {{ item.reorder_level }}
                    </td>
                    <td class="px-6 py-4">
                        {% if item.status == 'OK' %}
                        <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">OK</span>
                        {% elif item.status == 'LOW' %}
                        <span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">LOW</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">OUT</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 font-medium">
                        ₦{% for product in products %}
                            {% if product.id == item.product_id %}
                                {{ format_naira(product.price) }}
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td class="px-6 py-4 font-bold">
                        ₦{{ format_naira(item.total_value) }}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        {% if item.last_movement %}
                            {{ item.last_movement.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                            Never
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Export Button -->
<div class="text-center">
    <button onclick="exportInventory()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
        <i class="fas fa-file-export mr-2"></i> Export Inventory Report
    </button>
</div>

<!-- Stock Adjustment Modal -->
<div id="stockAdjustmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Adjust Stock</h3>

        <form id="adjustStockForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Product</label>
                    <select id="productSelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Choose a product...</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" data-stock="{{ product.stock_quantity }}">
                            {{ product.name }} (Current: {{ product.stock_quantity }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Adjustment Type</label>
                    <select id="adjustmentType" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="purchase">Add Stock (Purchase)</option>
                        <option value="manual_adjustment">Manual Adjustment</option>
                        <option value="customer_return">Customer Return</option>
                        <option value="damage">Damage/Waste</option>
                        <option value="sale">Sale Deduction</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <div class="flex space-x-2">
                        <button type="button" onclick="changeQuantity(-1)" class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="quantity" value="1" class="flex-1 px-3 py-2 border rounded-lg text-center">
                        <button type="button" onclick="changeQuantity(1)" class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Use negative numbers to reduce stock</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reference/Notes</label>
                    <input type="text" id="reference" placeholder="PO number, reason, etc." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>

            <div class="flex space-x-3 mt-6">
                <button type="button" onclick="submitStockAdjustment()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700">
                    <i class="fas fa-save mr-2"></i>Apply Adjustment
                </button>
                <button type="button" onclick="closeStockAdjustmentModal()" class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg hover:bg-gray-300">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Success/Error Toast -->
<div id="toast" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
    <i class="fas fa-check-circle mr-2"></i>
    <span id="toastMessage"></span>
</div>

<script>
function showStockAdjustmentModal() {
    document.getElementById('stockAdjustmentModal').classList.remove('hidden');
    // Clear previous values
    document.getElementById('quantity').value = '1';
    document.getElementById('reference').value = '';
}

function closeStockAdjustmentModal() {
    document.getElementById('stockAdjustmentModal').classList.add('hidden');
}

function changeQuantity(change) {
    const input = document.getElementById('quantity');
    let value = parseInt(input.value) || 0;
    value += change;
    // Allow negative values for stock reduction
    input.value = value;
}

function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    toastMessage.textContent = message;
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`;
    toast.classList.remove('hidden');

    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

async function submitStockAdjustment() {
    const productId = document.getElementById('productSelect').value;
    const adjustmentType = document.getElementById('adjustmentType').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const reference = document.getElementById('reference').value;

    if (!productId) {
        showToast('Please select a product', true);
        return;
    }

    if (isNaN(quantity) || quantity === 0) {
        showToast('Please enter a valid quantity', true);
        return;
    }

    // Show loading
    showToast('Updating stock...');

    try {
        const response = await fetch('/api/adjust-stock', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                product_id: productId,
                quantity: quantity,
                adjustment_type: adjustmentType,
                reference: reference || `${adjustmentType} adjustment`,
                notes: `Stock adjustment via inventory page`
            })
        });

        const data = await response.json();

        if (data.success) {
            showToast(`✅ ${data.message} → New stock: ${data.new_stock}`);

            // Close modal and reload page after 1.5 seconds
            setTimeout(() => {
                closeStockAdjustmentModal();
                location.reload(); // Refresh to show updated stock
            }, 1500);
        } else {
            showToast(`❌ Error: ${data.error}`, true);
        }
    } catch (error) {
        showToast(`❌ Network error: ${error.message}`, true);
        console.error('Stock adjustment error:', error);
    }
}

function exportInventory() {
    showToast('Generating inventory report...');
    // Create a download link
    const csvContent = "data:text/csv;charset=utf-8," + generateCSV();
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `inventory_report_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('✅ Inventory report downloaded!');
}

function generateCSV() {
    // Generate CSV content from the table
    let csv = "Product,Product ID,Current Stock,Reorder Level,Status,Unit Price,Total Value,Last Updated\n";

    // Get data from the table rows
    document.querySelectorAll('tbody tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 7) {
            const productName = cells[0].querySelector('.font-medium').textContent.trim();
            const productId = cells[0].querySelector('.text-sm').textContent.replace('ID: ', '').trim();
            const stock = cells[1].textContent.trim();
            const minLevel = cells[2].textContent.trim();
            const status = cells[3].textContent.trim();
            const price = cells[4].textContent.trim().replace('₦', '').replace(/,/g, '');
            const value = cells[5].textContent.trim().replace('₦', '').replace(/,/g, '');
            const updated = cells[6].textContent.trim();

            csv += `"${productName}",${productId},${stock},${minLevel},${status},${price},${value},"${updated}"\n`;
        }
    });

    return csv;
}

// Close modal when clicking outside
document.getElementById('stockAdjustmentModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeStockAdjustmentModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('stockAdjustmentModal').classList.contains('hidden')) {
        closeStockAdjustmentModal();
    }
});

// Auto-select adjustment type based on quantity sign
document.getElementById('quantity').addEventListener('change', function() {
    const quantity = parseInt(this.value) || 0;
    const typeSelect = document.getElementById('adjustmentType');

    if (quantity < 0) {
        // Negative quantity - likely sale or damage
        if (typeSelect.value === 'purchase') {
            typeSelect.value = 'sale';
        }
    } else {
        // Positive quantity - likely purchase or return
        if (typeSelect.value === 'sale') {
            typeSelect.value = 'purchase';
        }
    }
});
</script>

<style>
.low-stock {
    background-color: #fef3c7 !important;
}
.out-of-stock {
    background-color: #fee2e2 !important;
}
.low-stock:hover, .out-of-stock:hover {
    opacity: 0.9;
}
</style>
{% endblock %}